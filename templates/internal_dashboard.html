<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>StarSon POS (AI-Powered) - Internal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f9f9f9; }
        h1, h2, h3 { color: #333; }
        .transaction-panel { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 1.5em; margin-top: 1em; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .error-banner { background: #ffdddd; border: 1px solid #ff9999; color: #d8000c; padding: 1em; margin-bottom: 1em; border-radius: 8px; }
        button { padding: 10px 15px; font-size: 14px; cursor: pointer; border-radius: 5px; border: 1px solid #ccc; background-color: #f0f0f0; transition: background-color 0.2s; }
        button:hover { background-color: #e8e8e8; }
        button:disabled { cursor: not-allowed; background-color: #e0e0e0; }
        #esg-report-panel { background-color: #e6f4ea; border-color: #b2d8b5; }
        .chart-container { width: 100%; max-width: 450px; margin: 1.5em auto; }
        .flex-container { display: flex; justify-content: space-around; align-items: flex-start; flex-wrap: wrap; gap: 1em; }
    </style>
</head>
<body>
    <h1>StarSon POS (Internal Dashboard)</h1>
    
    <div class="error-banner" id="error-banner" style="display: none;"></div>

    {% if not saf_api_available %}
        <div class="error-banner">WARNING: M-Pesa STK Push is not configured. Limited functionality.</div>
    {% endif %}

    <div>
        <button onclick="startNewSTKPush()" {% if not saf_api_available %}disabled{% endif %}>New M-Pesa STK Push</button>
        <button onclick="startNewQRTransaction()" {% if not saf_api_available %}disabled{% endif %}>New QR Code Payment</button>
        <button onclick="startNewManual()">Log a Manual Payment</button>
        <a href="/public_esg_dashboard" target="_blank"><button>View Public ESG Dashboard</button></a>
    </div>

    <div style="margin-top: 1.5em;">
        <button onclick="getDailySummary()" id="summary-btn">Get Apillo's Daily Summary</button>
        <button onclick="getEsgReport()" id="esg-btn">Build Internal ESG Dashboard</button>
        <button onclick="getCorporateEsgReport()" id="corp-esg-btn">Get Corporate ESG Report</button>
    </div>

    <div id="apillo-summary-panel" class="transaction-panel" style="display:none; background-color: #f0f8ff;"></div>
    
    <div id="esg-report-panel" class="transaction-panel" style="display:none;">
        <h3>Apillo's Internal ESG Dashboard</h3>
        <p id="esg-summary-text"></p>
        <div class="flex-container">
            <div class="chart-container">
                <h4>Granular Environmental Impact</h4>
                <canvas id="environmentalChart"></canvas>
            </div>
            <div class="chart-container">
                <h4>Social & Community Impact</h4>
                <canvas id="socialChart"></canvas>
            </div>
        </div>
        <p style="text-align: center; margin-top: 1em;"><b>Apillo's Sustainability Insight:</b> <span id="esg-insight-text"></span></p>
    </div>

    <div id="corporate-esg-panel" class="transaction-panel" style="display:none; background-color: #e3f2fd;">
        <h3>Apillo's Corporate ESG Profile</h3>
        <div id="corporate-esg-content"></div>
    </div>
    
    <div id="active-transactions"></div>

<script>
    // Chart instances
    let environmentalChartInstance = null;
    let socialChartInstance = null;

    // All JS functions (startNewSTKPush, getEsgReport, etc.) are defined here
    // These functions will be updated to handle the new data structures

    async function getEsgReport() {
        const btn = document.getElementById('esg-btn');
        const panel = document.getElementById('esg-report-panel');
        btn.disabled = true;
        btn.innerText = "Building Dashboard...";
        
        try {
            const response = await fetch('/apillo/esg_report');
            const report = await response.json();
            if (!response.ok) throw new Error(report.error || 'Failed to get ESG report.');

            document.getElementById('esg-summary-text').innerText = `Based on today's transactions, including ${report.environmental_impact.digital_receipts} paperless receipts.`;
            document.getElementById('esg-insight-text').innerText = report.sustainability_insight.esg_insight;
            
            // --- UPDATED Chart Rendering --- 
            const envData = report.environmental_impact;
            if (environmentalChartInstance) environmentalChartInstance.destroy();
            const envCtx = document.getElementById('environmentalChart').getContext('2d');
            environmentalChartInstance = new Chart(envCtx, {
                type: 'bar',
                data: {
                    labels: ['Carbon Footprint (kg)', 'Water Usage (L)'],
                    datasets: [{
                        label: 'Product-Level Impact',
                        data: [envData.product_level_carbon_footprint_kg, envData.product_level_water_usage_l],
                        backgroundColor: ['#4CAF50', '#2196F3'],
                    }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });

            // Social chart remains the same for now
            // ...

            panel.style.display = 'block';

        } catch (error) {
            // Error handling...
        } finally {
            btn.disabled = false;
            btn.innerText = "Rebuild Internal ESG Dashboard";
        }
    }

    // Other JS functions (getCorporateEsgReport, etc.) remain largely the same
    // ...

</script>
</body>
</html>
