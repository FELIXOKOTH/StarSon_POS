<!DOCTYPE html>
<html lang="{{ current_lang }}">
<head>
    <meta charset="UTF-8">
    <title>{{ _('dashboard_title') }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-sha256"></script> <!-- For client number generation -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="text-center">{{ _('dashboard_title') }}</h1>
            <div class="header-controls">
                <div class="language-switcher">
                    <span>{{ _('language') }}:</span>
                    {% for code, name in supported_languages.items() %}
                        {% if code == current_lang %}<b>{{ name }}</b>{% else %}<a href="/set_language/{{ code }}">{{ name }}</a>{% endif %}
                        {% if not loop.last %} | {% endif %}
                    {% endfor %}
                </div>
                <a href="/logout" class="button-link">{{ _('logout') }}</a>
            </div>
        </div>

        <!-- ... (Error banners and other panels remain the same) ... -->

        <div class="panel">
            <h2>{{ _('actions') }}</h2>
            
            <!-- NEW: Privacy-First Manual Transaction -->
            <div class="transaction-entry">
                <input type="text" id="optional-client-name" placeholder="{{ _('optional_client_name') }}">
                <input type="text" id="marketing-qr-url" placeholder="{{ _('marketing_qr_url') }}" value="https://www.your-campaign.com">
                <button onclick="logAndShowReceipt()">{{ _('log_manual_transaction') }}</button>
            </div>

            <hr style="margin: 20px 0;">

            <button onclick="initiateMpesaPayment()" {% if not saf_api_available %}disabled{% endif %}>{{ _('initiate_mpesa_payment') }}</button>
            <button onclick="generateESGReport()">{{ _('generate_esg_report') }}</button>
            <a href="/public/esg_dashboard" target="_blank" class="button-link">{{ _('view_public_dashboard') }}</a>
            <a href="/chatbot" class="button-link">ESG Chatbot</a>
            
            <!-- ... (Subscription-based buttons remain the same) ... -->
        </div>

        <!-- ... (Other panels like AI Analytics, etc. remain the same) ... -->

    </div>

    <!-- NEW: Receipt Modal (Hidden by default) -->
    <div id="receipt-modal-overlay" class="modal-overlay">
        <div class="receipt-modal">
            <div class="receipt-header">
                <h2><span class="icon">ðŸ“„</span> StarSon POS</h2>
            </div>

            <div class="receipt-details-grid">
                <div id="receipt-merchant-name"></div>
                <div>{{ _('receipt_no') }}: <span id="receipt-no"></span></div>
                <div id="receipt-client-info"></div> <!-- Client Name or Number -->
                <div>{{ _('served_by') }}: <span id="receipt-served-by"></span></div>
                <div id="receipt-date"></div>
                <div>{{ _('payment_method') }}: <span id="receipt-payment-method"></span></div>
            </div>

            <div class="receipt-items">
                <table>
                    <tbody id="receipt-items-body"></tbody>
                </table>
            </div>

            <div class="receipt-totals">
                <table>
                    <tbody>
                        <tr>
                            <td class="label">{{ _('subtotal') }}</td>
                            <td class="value" id="receipt-subtotal"></td>
                        </tr>
                        <tr>
                            <td class="label">{{ _('vat') }} (16%)</td>
                            <td class="value" id="receipt-vat"></td>
                        </tr>
                        <tr class="total">
                            <td class="label">{{ _('total') }}</td>
                            <td class="value" id="receipt-total"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="eco-impact">
                <span class="icon">ðŸŒ¿</span>
                <div id="receipt-eco-impact"></div>
            </div>

            <div class="digital-footer">
                <img id="receipt-qr-code" src="" alt="Marketing QR Code" style="max-width: 120px; margin-top: 15px;">
                <p>{{ _('digital_receipt_thank_you') }}</p>
            </div>

            <div class="receipt-actions">
                <button class="btn-download">{{ _('download_pdf') }}</button>
                <button class="btn-close" onclick="closeReceipt()">{{ _('close') }}</button>
            </div>
        </div>
    </div>

    <script>
    // --- NEW: Receipt Generation Logic ---
    function logAndShowReceipt() {
        const clientName = document.getElementById('optional-client-name').value;
        const marketingUrl = document.getElementById('marketing-qr-url').value;
        
        // Generate a unique, anonymous client number
        const uniqueId = new Date().toISOString() + Math.random();
        const clientNumber = "CL-" + sha256(uniqueId).substring(0, 8).toUpperCase();

        // Dummy transaction data - in a real app, this would come from the POS interface
        const transaction = {
            items: [
                { name: "Milk x 2", price: 90.00 },
                { name: "Bread x 2", price: 100.00 },
                { name: "Apple x 2", price: 40.00 },
            ],
            paymentMethod: "Cash",
            servedBy: "{{ session.username }}", // Assuming the logged-in user is the server
            merchantName: "{{ merchant_name }}", // Passed from backend
            clientName: clientName, // Optional
            clientNumber: clientNumber, // Always generated
        };
        
        // --- Populate and Show Receipt ---
        showReceipt(transaction, marketingUrl);
        
        // --- Log Transaction to Backend (as before) ---
        fetch('/log_transaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(transaction)
        });
    }

    function showReceipt(transaction, marketingUrl) {
        // 1. Populate details
        document.getElementById('receipt-merchant-name').textContent = transaction.merchantName;
        document.getElementById('receipt-no').textContent = `#SR-${Math.floor(100000 + Math.random() * 900000)}`;
        
        if (transaction.clientName) {
            document.getElementById('receipt-client-info').innerHTML = `{{ _('client') }}: <span>${transaction.clientName}</span>`;
        } else {
            document.getElementById('receipt-client-info').innerHTML = `{{ _('client_number') }}: <span>${transaction.clientNumber}</span>`;
        }

        document.getElementById('receipt-served-by').textContent = transaction.servedBy;
        document.getElementById('receipt-date').textContent = new Date().toLocaleString('en-US', { dateStyle: 'short', timeStyle: 'medium' });
        document.getElementById('receipt-payment-method').textContent = transaction.paymentMethod;

        // 2. Populate items
        const itemsBody = document.getElementById('receipt-items-body');
        itemsBody.innerHTML = '';
        let subtotal = 0;
        transaction.items.forEach(item => {
            const row = itemsBody.insertRow();
            row.innerHTML = `<td class="item-name">${item.name}</td><td class="item-price">KES ${item.price.toFixed(2)}</td>`;
            subtotal += item.price;
        });

        // 3. Calculate and populate totals
        const vat = subtotal * 0.16;
        const total = subtotal + vat;
        document.getElementById('receipt-subtotal').textContent = `KES ${subtotal.toFixed(2)}`;
        document.getElementById('receipt-vat').textContent = `KES ${vat.toFixed(2)}`;
        document.getElementById('receipt-total').textContent = `KES ${total.toFixed(2)}`;

        // 4. Eco impact (dummy value)
        const carbonSaved = (total / 50).toFixed(2); // Example calculation
        document.getElementById('receipt-eco-impact').textContent = `{{ _('eco_impact_saved') }} ${carbonSaved}g of carbon/paper waste.`;

        // 5. Set QR Code
        const qrCodeImg = document.getElementById('receipt-qr-code');
        if (marketingUrl) {
            qrCodeImg.src = `/generate_qr?data=${encodeURIComponent(marketingUrl)}`;
            qrCodeImg.style.display = 'block';
        } else {
            qrCodeImg.style.display = 'none';
        }

        // 6. Show the modal
        document.getElementById('receipt-modal-overlay').style.display = 'flex';
    }

    function closeReceipt() {
        document.getElementById('receipt-modal-overlay').style.display = 'none';
    }

    // ... (Existing AI/Analytics JS functions remain the same) ...
    </script>

</body>
</html>
