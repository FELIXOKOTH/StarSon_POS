<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>StarSon Sustainability Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <!-- ** NEW: Firebase SDK (deferred) ** -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js" defer></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        .progress-bar-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: .25rem;
            margin-top: 0.5rem;
        }
        .progress-bar {
            height: 1.2rem;
            background-color: #28a745;
            border-radius: .25rem;
            text-align: center;
            color: white;
            line-height: 1.2rem;
            font-size: 0.8rem;
            transition: width 0.5s ease-in-out;
        }
        .controls-panel {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <header class="text-center" style="background-color: #28a745; color: white; padding: 2rem 1rem;">
        <h1>Our Commitment to Sustainability</h1>
        <p>Powered by Apillo AI</p>
    </header>

    <div class="container">
        <div class="panel controls-panel">
            <div>
                <label><input type="checkbox" id="toggleDigitalImpact" checked> Show Operational Impact</label>
            </div>
            <div>
                <label><input type="checkbox" id="toggleGranularImpact" checked> Show Product Impact</label>
            </div>
            <div>
                <label for="chartTypeSelector">Product Impact Chart Type:</label>
                <select id="chartTypeSelector">
                    <option value="bar">Bar</option>
                    <option value="doughnut">Doughnut</option>
                </select>
            </div>
        </div>

        <div id="goal-tracking-section" class="panel">
            <h2>Monthly Sustainability Goals</h2>
             <div class="kpi-grid">
                <div>
                    <h4>Carbon Reduction (kg)</h4>
                    <div class="progress-bar-container">
                        <div id="carbon-progress" class="progress-bar" style="width: 0%;" data-goal="{{ esg_goals.monthly_carbon_reduction_kg }}">0 / {{ esg_goals.monthly_carbon_reduction_kg }}</div>
                    </div>
                </div>
                <div>
                    <h4>Water Saved (L)</h4>
                    <div class="progress-bar-container">
                        <div id="water-progress" class="progress-bar" style="width: 0%;" data-goal="{{ esg_goals.monthly_water_saved_liters }}">0 / {{ esg_goals.monthly_water_saved_liters }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="todays-impact-section" class="panel">
            <h2>Today's Positive Impact</h2>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <h3>Digital Receipts</h3>
                    <p id="digital-receipts" class="value">0</p>
                </div>
                <div class="kpi-card">
                    <h3>Community Give-Back</h3>
                    <p id="community-give-back" class="value">0 KES</p>
                </div>
                <div class="kpi-card">
                    <h3>Carbon Footprint</h3>
                    <p id="granular-carbon" class="value">0 kg</p>
                </div>
                <div class="kpi-card">
                    <h3>Water Usage</h3>
                    <p id="granular-water" class="value">0 L</p>
                </div>
                <div class="kpi-card">
                    <h3>Trees Saved</h3>
                    <p id="trees-saved" class="value">0</p>
                </div>
            </div>
        </div>

        <div class="insight panel">
            <p><strong>Apillo's Insight:</strong> <span id="esg-insight">Connecting to real-time data...</span></p>
        </div>

        <div class="chart-grid">
            <div id="digitalImpactChartContainer" class="chart-container">
                <h3>Environmental Impact from Operations</h3>
                <canvas id="digitalImpactChart"></canvas>
            </div>
            <div id="granularImpactChartContainer" class="chart-container">
                <h3>Product-Specific Impact</h3>
                <canvas id="granularImpactChart"></canvas>
            </div>
        </div>
    </div>

    <footer class="text-center" style="margin-top: 3rem; padding: 1rem; color: #6c757d; font-size: 0.9rem;">
        <p>&copy; <span id="year"></span> StarSon Industries. All Rights Reserved.</p>
    </footer>

<script>
(function() {
    // ** IMPORTANT: Replace with your actual Firebase configuration **
    // Note: It is strongly recommended to load this from a secure backend endpoint
    // rather than hardcoding it in a public file.
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY", // E.g., AIzaSy...
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID", // E.g., 1:sender:web:id
      measurementId: "G-YOUR_MEASUREMENT_ID"
    };

    let digitalImpactChart, granularImpactChart;
    let currentGranularData = {};

    function initializeFirebase() {
        if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("YOUR_")) {
            console.warn("Firebase is not configured. Please update firebaseConfig in public_dashboard.html");
            document.getElementById('esg-insight').textContent = 'Real-time data connection failed: Firebase not configured.';
            return;
        }

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const transactionsRef = database.ref('transactions');

        transactionsRef.on('value', (snapshot) => {
            const allTransactions = snapshot.val() || {};
            console.log("Received real-time data:", allTransactions);
            updateDashboard(allTransactions);
        });
    }

    async function getApilloInsights(transactions) {
        try {
            const requestOptions = {
                method: 'POST',
                body: JSON.stringify(transactions),
                headers: {'Content-Type': 'application/json'}
            };
            const [envImpactRes, socialImpactRes, esgInsightRes] = await Promise.all([
                fetch("/api/calculate_environmental_impact", requestOptions),
                fetch("/api/calculate_social_impact", requestOptions),
                fetch("/api/get_sustainability_insights", requestOptions)
            ]);

            const environmental_impact = await envImpactRes.json();
            const social_impact = await socialImpactRes.json();
            const sustainability_insight = await esgInsightRes.json();

            return { environmental_impact, social_impact, sustainability_insight };

        } catch (error) {
            console.error("Error fetching Apillo insights:", error);
            return { environmental_impact: {}, social_impact: {}, sustainability_insight: {esg_insight: 'Error fetching AI insights.'} };
        }
    }

    function updateProgressBar(elementId, currentValue, goalValue) {
        const progressBar = document.getElementById(elementId);
        if (!progressBar) return;

        const goal = parseFloat(goalValue);
        const current = parseFloat(currentValue) || 0;

        let percentage = 0;
        if (goal > 0) {
            percentage = (current / goal) * 100;
        }

        const displayPercentage = Math.min(100, percentage);
        progressBar.style.width = `${displayPercentage}%`;
        progressBar.textContent = `${current.toFixed(2)} / ${goal}`;
    }

    async function updateDashboard(transactions) {
        const { environmental_impact, social_impact, sustainability_insight } = await getApilloInsights(transactions);

        // Update KPIs
        document.getElementById('digital-receipts').textContent = environmental_impact.digital_receipts || 0;
        document.getElementById('community-give-back').textContent = `${social_impact.community_give_back_kes || 0} KES`;
        document.getElementById('granular-carbon').textContent = `${(environmental_impact.granular_carbon_footprint_kg || 0).toFixed(2)} kg`;
        document.getElementById('granular-water').textContent = `${(environmental_impact.granular_water_usage_l || 0).toFixed(2)} L`;
        document.getElementById('trees-saved').textContent = (environmental_impact.trees_saved || 0).toFixed(4);
        document.getElementById('esg-insight').textContent = sustainability_insight.esg_insight || 'No insights available.';

        // Update Progress Bars
        const carbonProgressEl = document.getElementById('carbon-progress');
        const waterProgressEl = document.getElementById('water-progress');
        updateProgressBar('carbon-progress', environmental_impact.granular_carbon_footprint_kg, carbonProgressEl.dataset.goal);
        updateProgressBar('water-progress', environmental_impact.granular_water_usage_l, waterProgressEl.dataset.goal);

        // Update Charts
        createDigitalImpactChart(environmental_impact);
        currentGranularData = environmental_impact; // Store data for chart type changes
        createGranularImpactChart(); // Re-create granular chart with new data
        toggleCharts();
    }

    function createDigitalImpactChart(data) {
        if (digitalImpactChart) digitalImpactChart.destroy();
        const digitalCtx = document.getElementById('digitalImpactChart').getContext('2d');
        digitalImpactChart = new Chart(digitalCtx, {
            type: 'doughnut',
            data: {
                labels: ['CO2 Reduction (kg)', 'Water Saved (L)', 'Waste Diverted (kg)'],
                datasets: [{
                    data: [
                        data.estimated_carbon_reduction_kg || 0,
                        data.water_saved_liters || 0,
                        data.waste_diverted_kg || 0
                    ],
                    backgroundColor: ['#40916c', '#52b788', '#95d5b2'],
                    hoverOffset: 4
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Savings from Paperless Transactions' } } }
        });
    }

    function createGranularImpactChart() {
        if (granularImpactChart) granularImpactChart.destroy();
        const chartType = document.getElementById('chartTypeSelector').value;
        const granularCtx = document.getElementById('granularImpactChart').getContext('2d');
        const labels = ['Total Carbon Footprint (kg)', 'Total Water Usage (L)'];
        const chartData = [currentGranularData.granular_carbon_footprint_kg || 0, currentGranularData.granular_water_usage_l || 0];

        const baseOptions = {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Total Resource Consumption' }
            }
        };

        let chartConfig;
        if (chartType === 'doughnut') {
            chartConfig = {
                type: 'doughnut',
                data: { labels, datasets: [{ data: chartData, backgroundColor: ['#d90429', '#0077b6'] }] },
                options: { ...baseOptions, plugins: { ...baseOptions.plugins, legend: { position: 'top' } } }
            };
        } else { // Bar chart
            chartConfig = {
                type: 'bar',
                data: { labels, datasets: [{ data: chartData, backgroundColor: ['#d90429', '#0077b6'] }] },
                options: { ...baseOptions, scales: { y: { beginAtZero: true } }, plugins: { ...baseOptions.plugins, legend: { display: false } } }
            };
        }
        granularImpactChart = new Chart(granularCtx, chartConfig);
    }

    function toggleCharts() {
        document.getElementById('digitalImpactChartContainer').style.display = document.getElementById('toggleDigitalImpact').checked ? 'block' : 'none';
        document.getElementById('granularImpactChartContainer').style.display = document.getElementById('toggleGranularImpact').checked ? 'block' : 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('year').textContent = new Date().getFullYear();

        // Add event listeners
        document.getElementById('toggleDigitalImpact').addEventListener('change', toggleCharts);
        document.getElementById('toggleGranularImpact').addEventListener('change', toggleCharts);
        document.getElementById('chartTypeSelector').addEventListener('change', createGranularImpactChart);

        // Initial setup
        initializeFirebase();
        createDigitalImpactChart({});
        createGranularImpactChart();
        toggleCharts();
    });
})();
</script>

</body>
</html>
