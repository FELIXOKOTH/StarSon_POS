<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>StarSon Sustainability Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        .progress-bar-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: .25rem;
            margin-top: 0.5rem;
        }
        .progress-bar {
            height: 1.2rem;
            background-color: #28a745;
            border-radius: .25rem;
            text-align: center;
            color: white;
            line-height: 1.2rem;
            font-size: 0.8rem;
        }
        .controls-panel { 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            padding: 1rem; 
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <header class="text-center" style="background-color: #28a745; color: white; padding: 2rem 1rem;">
        <h1>Our Commitment to Sustainability</h1>
        <p>Powered by Apillo AI</p>
    </header>

    <div class="container">
        <div class="panel controls-panel">
            <div>
                <label><input type="checkbox" id="toggleDigitalImpact" checked onchange="updateDashboard()"> Show Operational Impact</label>
            </div>
            <div>
                <label><input type="checkbox" id="toggleGranularImpact" checked onchange="updateDashboard()"> Show Product Impact</label>
            </div>
            <div>
                <label for="chartTypeSelector">Product Impact Chart Type:</label>
                <select id="chartTypeSelector" onchange="updateDashboard()">
                    <option value="bar">Bar</option>
                    <option value="doughnut">Doughnut</option>
                </select>
            </div>
        </div>

        <div id="goal-tracking-section" class="panel">
            <h2>Monthly Sustainability Goals</h2>
            <!-- Goal tracking content is unchanged -->
        </div>

        <div id="todays-impact-section" class="panel">
            <h2>Today's Positive Impact</h2>
            <!-- KPI cards are unchanged -->
        </div>

        <div class="insight panel">
            <p><strong>Apillo's Insight:</strong> {{ sustainability_insight.esg_insight }}</p>
        </div>

        <div class="chart-grid">
            <div id="digitalImpactChartContainer" class="chart-container">
                <h3>Environmental Impact from Operations</h3>
                <canvas id="digitalImpactChart"></canvas>
            </div>
            <div id="granularImpactChartContainer" class="chart-container">
                <h3>Product-Specific Impact</h3>
                <canvas id="granularImpactChart"></canvas>
            </div>
        </div>
    </div>

    <footer class="text-center" style="margin-top: 3rem; padding: 1rem; color: #6c757d; font-size: 0.9rem;">
        <p>&copy; {{ now.year }} StarSon Industries. All Rights Reserved.</p>
    </footer>

<script>
    const envImpact = {{ environmental_impact | tojson }};
    let digitalImpactChart, granularImpactChart;

    function createDigitalImpactChart() {
        const digitalCtx = document.getElementById('digitalImpactChart').getContext('2d');
        digitalImpactChart = new Chart(digitalCtx, {
            type: 'doughnut',
            data: {
                labels: ['CO2 Reduction (kg)', 'Water Saved (L)', 'Waste Diverted (kg)'],
                datasets: [{
                    data: [
                        envImpact.estimated_carbon_reduction_kg,
                        envImpact.water_saved_liters,
                        envImpact.waste_diverted_kg
                    ],
                    backgroundColor: ['#40916c', '#52b788', '#95d5b2'],
                    hoverOffset: 4
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Savings from Paperless Transactions' } } }
        });
    }

    function createGranularImpactChart(chartType = 'bar') {
        if (granularImpactChart) {
            granularImpactChart.destroy();
        }
        const granularCtx = document.getElementById('granularImpactChart').getContext('2d');
        const labels = envImpact.itemized_impact.map(item => item.product_name);
        const carbonData = envImpact.itemized_impact.map(item => item.carbon_footprint_kg);
        const waterData = envImpact.itemized_impact.map(item => item.water_usage_l);

        let chartConfig;
        if (chartType === 'doughnut') {
            chartConfig = {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Carbon Footprint (kg)', data: carbonData, backgroundColor: ['#d90429', '#ffb703', '#023047', '#219ebc', '#8ecae6'] },
                        { label: 'Water Usage (L)', data: waterData, backgroundColor: ['#0077b6', '#00b4d8', '#90e0ef', '#caf0f8', '#ade8f4'] }
                    ]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Product Impact Distribution' } } }
            };
        } else { // bar chart
            chartConfig = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Carbon Footprint (kg)', data: carbonData, backgroundColor: '#d90429' },
                        { label: 'Water Usage (L)', data: waterData, backgroundColor: '#0077b6' }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Product-Specific Resource Consumption' } } }
            };
        }
        granularImpactChart = new Chart(granularCtx, chartConfig);
    }

    function updateDashboard() {
        // Toggle chart visibility
        document.getElementById('digitalImpactChartContainer').style.display = document.getElementById('toggleDigitalImpact').checked ? 'block' : 'none';
        document.getElementById('granularImpactChartContainer').style.display = document.getElementById('toggleGranularImpact').checked ? 'block' : 'none';

        // Re-create granular chart with selected type
        const chartType = document.getElementById('chartTypeSelector').value;
        createGranularImpactChart(chartType);
    }

    // Initial chart creation on page load
    document.addEventListener('DOMContentLoaded', () => {
        createDigitalImpactChart();
        updateDashboard();
    });
</script>

</body>
</html>
